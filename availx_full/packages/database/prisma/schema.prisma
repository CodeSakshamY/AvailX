// LocalPro Connect - Complete Database Schema
// Generator and datasource configuration

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [pgvector(map: "vector")]
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  CUSTOMER
  PROVIDER
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum CancelledBy {
  CUSTOMER
  PROVIDER
  ADMIN
}

enum PaymentMethod {
  CASH
  UPI
  CARD
  WALLET
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum MessageType {
  TEXT
  IMAGE
  DOCUMENT
  VOICE
  LOCATION
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================================================
// USER & PROFILES
// ============================================================================

model User {
  id            String    @id @default(cuid())
  role          UserRole
  phone         String    @unique
  phoneVerified Boolean   @default(false)
  email         String?   @unique
  emailVerified Boolean   @default(false)
  name          String
  profilePhoto  String?

  // Auth
  passwordHash  String?

  // Timestamps
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  lastLoginAt   DateTime?

  // Relations
  customerProfile CustomerProfile?
  providerProfile ProviderProfile?
  sentMessages    Message[]
  sessions        Session[]
  accounts        Account[]

  @@index([phone])
  @@index([email])
  @@index([role])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model CustomerProfile {
  id           String    @id @default(cuid())
  userId       String    @unique
  dateOfBirth  DateTime?
  addresses    Json?     // Array of addresses
  savedLocations Json?   // Array of saved locations

  // Preferences
  preferredLanguage String @default("en")
  notificationPreferences Json?

  // Stats
  totalBookings     Int      @default(0)
  completedBookings Int      @default(0)

  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  bookings     Booking[]
  reviews      Review[]
  chatRooms    ChatRoom[]

  @@map("customer_profiles")
}

model ProviderProfile {
  id              String    @id @default(cuid())
  userId          String    @unique
  businessName    String?
  description     String?
  categoryId      String
  subCategoryIds  String[]  // Array of subcategory IDs

  // Verification
  aadhaarVerified    Boolean   @default(false)
  aadhaarMasked      String?   // XXXX-XXXX-1234
  aadhaarVerifiedAt  DateTime?
  backgroundVerified Boolean   @default(false)
  backgroundVerifiedAt DateTime?

  // Profile status
  profileStatus      VerificationStatus @default(PENDING)
  rejectionReason    String?
  isActive           Boolean   @default(false)

  // Service Info
  serviceAreas    Json?     // Array of {type: 'radius'|'pincodes', value: number|string[]}
  baseLocation    Json?     // {lat: number, lng: number, address: string}
  pricing         Json?     // {hourlyRate?: number, fixedPrice?: number, custom?: string}
  workingHours    Json?     // {monday: {start: '09:00', end: '18:00'}, ...}
  availability    Json?     // Calendar data

  // Stats
  totalJobs           Int       @default(0)
  completedJobs       Int       @default(0)
  cancelledJobs       Int       @default(0)
  averageRating       Decimal   @default(0) @db.Decimal(3, 2)
  reputationScore     Decimal   @default(0) @db.Decimal(5, 2)
  responseTimeSeconds Int       @default(0) // Average response time

  // AI Features
  embedding           Unsupported("vector(1536)")? // For semantic search

  // Timestamps
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  category        Category  @relation(fields: [categoryId], references: [id])
  bookings        Booking[]
  reviews         Review[]
  portfolioPhotos ProviderPhoto[]
  certifications  Certification[]
  chatRooms       ChatRoom[]

  @@index([categoryId])
  @@index([isActive])
  @@index([reputationScore])
  @@index([averageRating])
  @@map("provider_profiles")
}

model ProviderPhoto {
  id         String   @id @default(cuid())
  providerId String
  url        String
  caption    String?
  sortOrder  Int      @default(0)
  createdAt  DateTime @default(now())

  provider   ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("provider_photos")
}

model Certification {
  id           String   @id @default(cuid())
  providerId   String
  title        String
  issuer       String?
  issueDate    DateTime?
  expiryDate   DateTime?
  documentUrl  String?
  verified     Boolean  @default(false)
  createdAt    DateTime @default(now())

  provider     ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("certifications")
}

// ============================================================================
// CATEGORIES
// ============================================================================

model Category {
  id                String         @id @default(cuid())
  name              String
  nameTranslations  Json           // {en: '', hi: '', ur: ''}
  slug              String         @unique
  icon              String?
  description       String?
  isActive          Boolean        @default(true)
  sortOrder         Int            @default(0)

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  subCategories     SubCategory[]
  providers         ProviderProfile[]

  @@index([slug])
  @@index([isActive])
  @@map("categories")
}

model SubCategory {
  id               String    @id @default(cuid())
  categoryId       String
  name             String
  nameTranslations Json      // {en: '', hi: '', ur: ''}
  slug             String    @unique
  description      String?
  isActive         Boolean   @default(true)
  sortOrder        Int       @default(0)

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  category         Category  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([slug])
  @@map("sub_categories")
}

// ============================================================================
// BOOKINGS
// ============================================================================

model Booking {
  id                  String         @id @default(cuid())
  bookingNumber       String         @unique // BK-2025-001234

  customerId          String
  providerId          String

  serviceType         String
  serviceLocation     Json           // {address, lat, lng}
  scheduledDate       DateTime
  scheduledTime       Json           // {start: '10:00', end: '12:00'}

  status              BookingStatus  @default(PENDING)
  cancellationReason  String?
  cancelledBy         CancelledBy?

  specialInstructions String?

  // Pricing
  quotedPrice         Decimal?       @db.Decimal(10, 2)
  finalPrice          Decimal?       @db.Decimal(10, 2)
  currency            String         @default("INR")

  // Timestamps
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt
  confirmedAt         DateTime?
  startedAt           DateTime?
  completedAt         DateTime?
  cancelledAt         DateTime?

  // Relations
  customer            CustomerProfile @relation(fields: [customerId], references: [id])
  provider            ProviderProfile @relation(fields: [providerId], references: [id])
  payment             Payment?
  review              Review?
  chatRoom            ChatRoom?

  @@index([customerId])
  @@index([providerId])
  @@index([status])
  @@index([scheduledDate])
  @@index([bookingNumber])
  @@map("bookings")
}

// ============================================================================
// PAYMENTS
// ============================================================================

model Payment {
  id                String         @id @default(cuid())
  bookingId         String         @unique

  amount            Decimal        @db.Decimal(10, 2)
  currency          String         @default("INR")
  method            PaymentMethod

  status            PaymentStatus  @default(PENDING)

  // For in-app payments
  transactionId     String?        @unique
  gatewayResponse   Json?

  // Platform Commission
  platformFee       Decimal?       @db.Decimal(10, 2)
  providerEarnings  Decimal?       @db.Decimal(10, 2)

  paidAt            DateTime?
  refundedAt        DateTime?

  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relations
  booking           Booking        @relation(fields: [bookingId], references: [id])

  @@index([transactionId])
  @@index([status])
  @@map("payments")
}

// ============================================================================
// REVIEWS & RATINGS
// ============================================================================

model Review {
  id                    String    @id @default(cuid())
  bookingId             String    @unique
  customerId            String
  providerId            String

  // Ratings (1-5)
  overallRating         Int
  qualityRating         Int?
  punctualityRating     Int?
  professionalismRating Int?
  valueRating           Int?

  // Review Content
  comment               String?
  photos                String[]  // Array of URLs

  // Moderation
  isPublished           Boolean   @default(true)
  isFlagged             Boolean   @default(false)
  flagReason            String?

  // Provider Response
  providerResponse      String?
  respondedAt           DateTime?

  // Helpful Votes
  helpfulCount          Int       @default(0)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  booking               Booking          @relation(fields: [bookingId], references: [id])
  customer              CustomerProfile  @relation(fields: [customerId], references: [id])
  provider              ProviderProfile  @relation(fields: [providerId], references: [id])

  @@index([providerId])
  @@index([overallRating])
  @@index([createdAt])
  @@map("reviews")
}

// ============================================================================
// CHAT & MESSAGING
// ============================================================================

model ChatRoom {
  id              String    @id @default(cuid())
  customerId      String
  providerId      String
  bookingId       String?   @unique

  lastMessageAt   DateTime?

  createdAt       DateTime  @default(now())

  // Relations
  customer        CustomerProfile @relation(fields: [customerId], references: [id])
  provider        ProviderProfile @relation(fields: [providerId], references: [id])
  booking         Booking?        @relation(fields: [bookingId], references: [id])
  messages        Message[]

  @@unique([customerId, providerId])
  @@index([customerId])
  @@index([providerId])
  @@map("chat_rooms")
}

model Message {
  id                String      @id @default(cuid())
  chatRoomId        String
  senderId          String

  type              MessageType @default(TEXT)
  content           String?     // Translated text
  originalContent   String?     // Original before translation
  detectedLanguage  String?

  mediaUrl          String?     // For IMAGE, DOCUMENT, VOICE
  location          Json?       // For LOCATION type: {lat, lng, address}

  isRead            Boolean     @default(false)
  readAt            DateTime?

  createdAt         DateTime    @default(now())

  // Relations
  chatRoom          ChatRoom    @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  sender            User        @relation(fields: [senderId], references: [id])

  @@index([chatRoomId])
  @@index([senderId])
  @@index([createdAt])
  @@map("messages")
}

// ============================================================================
// ADMIN & SYSTEM
// ============================================================================

model AdminLog {
  id          String   @id @default(cuid())
  userId      String
  action      String   // e.g., "APPROVE_PROVIDER", "BAN_USER"
  entityType  String   // e.g., "USER", "BOOKING", "REVIEW"
  entityId    String
  details     Json?
  ipAddress   String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("admin_logs")
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  type        String   // e.g., "BOOKING_CONFIRMED", "NEW_MESSAGE"
  title       String
  body        String
  data        Json?
  isRead      Boolean  @default(false)
  readAt      DateTime?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model SearchLog {
  id              String   @id @default(cuid())
  userId          String?
  query           String
  filters         Json?
  resultsCount    Int
  clickedProviderId String?
  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([createdAt])
  @@map("search_logs")
}
